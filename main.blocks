<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="wXvw2`rH4v3JGs?-sTk@">players</variable><variable id="?SE7EEPQi$~TO)$Kj+{8">p</variable><variable id="am:[tvD[VIL4h5pdKMv=">q</variable><variable id="qZ41MJ$5vtjxcO8)#;_i">r</variable><variable id="w}cJ[/Q|S~0sl)(KMVs=">patientZero</variable><variable id="IYDieU^?d+0ZFPj1~ZlJ">state</variable><variable id="Rs[1(6;Wg]z*qRA6`q=d">master</variable><variable id="5(J5#-Rpa)*SOQIe,2[:">paired</variable><variable id="Uf9U-r2(RdmJQ0zEG|r/">signal</variable><variable id="c}kgcKDD8]BwLA|jn7):">INCUBATION</variable><variable id="08J1X1#l~`b}0a-=N}4`">DEATH</variable><variable id="#o4m0:u#{BMtAufXZn(u">RSSI</variable><variable id="-bns-*!k2%]Oqqx^?5EL">TRANSMISSIONPROB</variable><variable id="Q[113xE4ML%@s5aTl:Cc">playerIcons</variable><variable id="`4B6@FJ*}H,$Y0z:dzuA">infectedBy</variable><variable id="w=_cAiSR`-lX}F-mL4Ry">playerIcon</variable></variables><comment id="0.pu]QX|wsk3;iT4$BA)" data="2" x="20" y="4233" h="120" w="160">player state</comment><comment id="R?eN@IX[[UvC5?yw(WnH" data="1" x="225" y="4233" h="120" w="160">master state</comment><comment id="IILW~Jk}D0ob||V-w)!o" data="0" x="430" y="4233" h="360" w="480">Infection game

Flash all micro:bits with this script

Press A+B to enter master mode (1 per game)

Wait for players to be paired. The number of paired player will display on screen.
An icon will appear on player's screen.

Press A+B to start the infection game. The master will pick a random
player as patient zero.

A player will transmit the disease if close enough (RSSI)
and with a certain probability (TRANSMISSIONPROB).
During the incudation phase (INCUBATION), the player does not show any sign
of illness. After that phase, the sad face shows up.

The game will automatically stop once all players are dead or healthy. The master can
also press A+B again to stop the game.

Once the game is over, the micro:bit will show the player id (A,B,C...), health and
who infected him.

Icons used in the game:

Pairing: IconNames.Ghost
Paired: IconNames.Happy
Dead: IconNames.Skull
Sick: IconNames.Sad
Incubating: IconNames.Confused
Healthy: IconNames.Happy</comment><block type="pxt-on-start" id="$Tah;.`3o{SaBw3q_6T`" x="20" y="20"><statement name="HANDLER"><block type="typescript_statement" id="Ir#GR_FTbyxLsEd`y4e`" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let infectedTime = 0" numlines="1" declaredvars="infectedTime"></mutation><next><block type="typescript_statement" id="ARgI+^}6DX-p)hQv?@,A" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let paired = false" numlines="1" declaredvars="paired"></mutation><next><block type="typescript_statement" id="G+vHb~fUUh7O-^GvA#6a" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let players: Player[] = []" numlines="1" declaredvars="players"></mutation><next><block type="variables_set" id="XR9FDmwu3b^@b?{h8eUa"><field name="VAR" id="c}kgcKDD8]BwLA|jn7):">INCUBATION</field><comment>time before showing symptoms</comment><data>0</data><value name="VALUE"><shadow type="math_number" id="?wP3_Z{VG)!+/xndH;ne"><field name="NUM">20000</field></shadow></value><next><block type="variables_set" id="/1P_4WF%]W{(NmV=?*]c"><field name="VAR" id="08J1X1#l~`b}0a-=N}4`">DEATH</field><comment>time before dying off the disease</comment><value name="VALUE"><shadow type="math_number" id="lVoSPb.d!?VullAvwkf?"><field name="NUM">40000</field></shadow></value><next><block type="variables_set" id="TB2YTzsjdG1~S}3tcV`f"><field name="VAR" id="#o4m0:u#{BMtAufXZn(u">RSSI</field><comment>db</comment><value name="VALUE"><shadow type="math_number" id="N,W5/Hdir:LPEkZjcg2Z"><field name="NUM">-45</field></shadow></value><next><block type="variables_set" id="o1SyAqSQG~.JT3?7i)hr"><field name="VAR" id="-bns-*!k2%]Oqqx^?5EL">TRANSMISSIONPROB</field><comment>% probability to transfer disease</comment><value name="VALUE"><shadow type="math_number" id="*I@0x^;(UK3oF8i`R:bh"><field name="NUM">40</field></shadow></value><next><block type="typescript_statement" id="Gay9{9W-Ss|TT?sMofU)" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum GameState {" line1="    Stopped," line2="    Pairing," line3="    Infecting," line4="    Running," line5="    Over" line6="}" numlines="7"></mutation><next><block type="typescript_statement" id="Fpu;WH=)mhlAu;G0/Fw." editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum HealthState {" line1="    Healthy," line2="    Incubating," line3="    Sick," line4="    Dead" line5="}" numlines="6"></mutation><next><block type="typescript_statement" id="iQny~gt~B]jlUQ;h,3H{" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="enum MessageKind {" line1="    PairRequest," line2="    PairConfirmation," line3="    HealthSet," line4="    HealthValue," line5="    InitialInfect," line6="    TransmitVirus," line7="    GameState" line8="}" numlines="9"></mutation><next><block type="typescript_statement" id="n$Z0tqgx4DBVz?#h8vuS" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="const GameIcons = {" line1="    Pairing: IconNames.Ghost," line2="    Paired: IconNames.Happy," line3="    Dead: IconNames.Skull," line4="    Sick: IconNames.Sad," line5="    Incubating: IconNames.Confused," line6="    Healthy: IconNames.Happy" line7="}" numlines="8" declaredvars="GameIcons"></mutation><next><block type="typescript_statement" id="3b+wagRVl{Acqo!e}I3z" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class Message {" line1="" line2="    private _data: Buffer;" line3="" line4="    constructor(input?: Buffer) {" line5="        this._data = input || control.createBuffer(13);" line6="    }" line7="" line8="    get kind(): number {" line9="        return this._data.getNumber(NumberFormat.Int8LE, 0);" line10="    }" line11="" line12="    set kind(x: number) {" line13="        this._data.setNumber(NumberFormat.Int8LE, 0, x);" line14="    }" line15="" line16="    get fromSerialNumber(): number {" line17="        return this._data.getNumber(NumberFormat.Int32LE, 1);" line18="    }" line19="" line20="    set fromSerialNumber(x: number) {" line21="        this._data.setNumber(NumberFormat.Int32LE, 1, x);" line22="    }" line23="" line24="    get value(): number {" line25="        return this._data.getNumber(NumberFormat.Int32LE, 5);" line26="    }" line27="" line28="    set value(x: number) {" line29="        this._data.setNumber(NumberFormat.Int32LE, 5, x);" line30="    }" line31="" line32="    get toSerialNumber(): number {" line33="        return this._data.getNumber(NumberFormat.Int32LE, 9);" line34="    }" line35="" line36="    set toSerialNumber(x: number) {" line37="        this._data.setNumber(NumberFormat.Int32LE, 9, x);" line38="    }" line39="" line40="    send() {" line41="        radio.sendBuffer(this._data);" line42="        basic.pause(250);" line43="    }" line44="}" numlines="45"></mutation><next><block type="variables_set" id="IF%D.I`V7y60-z%}v:fm"><field name="VAR" id="Q[113xE4ML%@s5aTl:Cc">playerIcons</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="text" id="#BDTe41Ex{s:FirEShj#"><field name="TEXT">ABCDEFGHIJKLMNOPQRSTUVWXYZ</field></block></value><next><block type="typescript_statement" id=")ob3g{[Rh,rX@a.Ivr^D" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class Player {" line1="    id: number;" line2="    icon: number;" line3="    health: HealthState;" line4="    show() {" line5="        basic.showString(playerIcons[this.icon]);" line6="    }" line7="}" numlines="8"></mutation><next><block type="typescript_statement" id="ya5}K)jupYp%a`|)0858" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let state = GameState.Stopped;" numlines="1" declaredvars="state"></mutation><next><block type="typescript_statement" id="4QJC|BGWsinuF%4:_`O9" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let patientZero: Player;" numlines="1" declaredvars="patientZero"></mutation><next><block type="variables_set" id="fxJMvRImQo8mbyV*QwNe"><field name="VAR" id="`4B6@FJ*}H,$Y0z:dzuA">infectedBy</field><comment>who infected (playerIcon)</comment><value name="VALUE"><shadow type="math_number" id="^ev0%h7Gb|Jt=FI4-r#U"><field name="NUM">-1</field></shadow></value><next><block type="variables_set" id=":`vuG/nRCzrPN@q%uqiJ"><field name="VAR" id="w=_cAiSR`-lX}F-mL4Ry">playerIcon</field><comment>local time when infection happened
player icon and identity</comment><value name="VALUE"><shadow type="math_number" id="/dxzLT:T462g?c?A2|Za"><field name="NUM">-1</field></shadow></value><next><block type="typescript_statement" id="q|*e.5`AVI=Wl|MeR0}F" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let health = HealthState.Healthy;" numlines="1" declaredvars="health"></mutation><next><block type="radio_set_group" id="n5;dU1LUNlhR41QC])ZR"><value name="ID"><shadow type="math_number_minmax" id="=mg(L@8|RAvP?}S=Tv~="><mutation min="0" max="255" label="Number" precision="0"/><field name="SLIDER">42</field></shadow></value><next><block type="typescript_statement" id="a*AnMtdr5#b#-;_*Er2O" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="basic.showIcon(GameIcons.Pairing)" numlines="1"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="device_button_event" id="njhe(pXpxRI+Y[,I(Gtq" x="686" y="20"><field name="NAME">Button.AB</field><statement name="HANDLER"><block type="controls_if" id="bk_/4TrlZ%fiIA7l9i@8"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_operation" id="b$wt2+$H]j^zfkUbK_S@"><field name="OP">AND</field><value name="A"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="-~/a$`Y]A=w_1Q={Lznb"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="sO*sw6}@Z}14[{8%.D/u"><field name="VAR" id="IYDieU^?d+0ZFPj1~ZlJ">state</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="3ROQ=#p`;f4]qAU-h++(" editable="false"><field name="EXPRESSION">GameState.Stopped</field></block></value></block></value><value name="B"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="JJzDLgv[`spEwCbnDlLg"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="@U]Ui[C(QuWOr.yktu-A"><field name="VAR" id="Rs[1(6;Wg]z*qRA6`q=d">master</field></block></value></block></value></block></value><statement name="DO0"><block type="variables_set" id="%v?,z7N5wrz}GlLd^bb6"><field name="VAR" id="Rs[1(6;Wg]z*qRA6`q=d">master</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="NJXsWZ+}X!/IeW7]q)28"><field name="BOOL">TRUE</field></block></value><next><block type="variables_set" id="Xw.~1|.`_~Axkxqdf;5E"><field name="VAR" id="5(J5#-Rpa)*SOQIe,2[:">paired</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id=")U{J5M(c?KSOc)Db}LIh"><field name="BOOL">TRUE</field></block></value><next><block type="typescript_statement" id="*[[29g2I@OgaA)+KbMAk" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="state = GameState.Pairing;" numlines="1"></mutation><next><block type="serial_writeline" id="JT_lZD/gKm]E,8XlPU]!"><value name="text"><shadow type="text" id="@55Fe@W+pZ-|{46}[/tR"><field name="TEXT">registered as master</field></shadow></value><next><block type="radio_set_transmit_power" id=")-1p7?Xx1|H[-[@8_d:/"><value name="power"><shadow type="math_number_minmax" id="d/ni]1yDCw1|3*Y$@}DP"><mutation min="0" max="7" label="Number" precision="0"/><field name="SLIDER">7</field></shadow></value><next><block type="device_print_message" id="$mv}[umJfPu`0#Zqb9q6"><value name="text"><shadow type="text" id="j?=3M[2uen#eS-|0rga7"><field name="TEXT">0</field></shadow></value><next><block type="typescript_statement" id="%,K*td_aeDd7HL01/)=%" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="return;" numlines="1"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></statement><next><block type="controls_if" id="G|Sd.q{FMQ;9n_3AOQ,0"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_negate" id="MAQV!Q6hLh^a=]a4u(y1"><value name="BOOL"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="BPj]=SwuF,?|a-e$IV*Z"><field name="VAR" id="Rs[1(6;Wg]z*qRA6`q=d">master</field></block></value></block></value><statement name="DO0"><block type="typescript_statement" id=":@v?edB3w]e^(S%f+OYD" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="return;" numlines="1"></mutation></block></statement><next><block type="controls_if" id="w.BH)OvOm2F)D]*Vm^^3"><mutation elseif="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="vqW]+kjiy6B(bO91psS1"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="~E.^(tGUb41lN@5DQBd1"><field name="VAR" id="IYDieU^?d+0ZFPj1~ZlJ">state</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="JS5_q{J:s]KUOy/_L|]I" editable="false"><field name="EXPRESSION">GameState.Pairing</field></block></value></block></value><statement name="DO0"><block type="variables_set" id="d4(Mei{^$acA=OM4Xb03"><field name="VAR" id="w}cJ[/Q|S~0sl)(KMVs=">patientZero</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="d2X$zgq9w_!X*7vQnZsW"><value name="LIST"><block type="variables_get" id="HraS,Z5)iz~h@[`|83Cy"><field name="VAR" id="wXvw2`rH4v3JGs?-sTk@">players</field></block></value><value name="INDEX"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="device_random" id="?wy.j%ig1XY,y%SfhnZL"><value name="min"><shadow type="math_number" id="u76Xi$99)sV+bIu~sAQA"><field name="NUM">0</field></shadow></value><value name="limit"><block type="math_arithmetic" id="Z8Uko.-2R+EH|^q;n7A1"><field name="OP">MINUS</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_length" id="3NN%4]oMJqgH3Xx104(/"><value name="VALUE"><block type="variables_get" id="oo.W#kbv,]fD0,e`fHyu"><field name="VAR" id="wXvw2`rH4v3JGs?-sTk@">players</field></block></value></block></value><value name="B"><shadow type="math_number" id="b+#k|w36ZxN+5~7PHV,k"><field name="NUM">1</field></shadow></value></block></value></block></value></block></value><next><block type="typescript_statement" id="K1b_EKVt_cMl$^Z5m6(%" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="state = GameState.Infecting;" numlines="1"></mutation><next><block type="serial_writeline" id="`N%*#m?.Pi52[gh;JyhP"><value name="text"><block type="typescript_expression" id="QAe4sGocdVqhxaZj.f+l" editable="false"><field name="EXPRESSION">`game started ${players.length} players`</field></block></value></block></next></block></next></block></statement><value name="IF1"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="kUJwhKH;c?Zf?)g=)h#7"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="9`7`trJ,wsLw.R$XKX7z"><field name="VAR" id="IYDieU^?d+0ZFPj1~ZlJ">state</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="Y6/E*?aq*/KY$ftPAYR/" editable="false"><field name="EXPRESSION">GameState.Running</field></block></value></block></value><statement name="DO1"><block type="function_call" id="_6z/al(^1`iy]N+Zg)%("><mutation name="gameOver" functionid="%W7iwgd5y3ncGw]Sg+S;"/></block></statement></block></next></block></next></block></statement></block><block type="device_forever" id="Ha-u^x@^P9?Gd=vijR*_" x="1980" y="20"><statement name="HANDLER"><block type="typescript_statement" id="H;@g[{qd@TWw8BgE/J!#" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let message: Message;" numlines="1" declaredvars="message"></mutation><next><block type="controls_if" id="{AA4WyvziHJhW/#@6^nR"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="pt~j.|.0;*/UY-8EMjj_"><field name="VAR" id="Rs[1(6;Wg]z*qRA6`q=d">master</field></block></value><statement name="DO0"><block type="typescript_statement" id="$tBcT.n0r[t~nDP=.Ce!" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (state) {" line1="            case GameState.Pairing:" line2="                // tell each player they are registered" line3="                for (const t of players) {" line4="                    message = new Message();" line5="                    message.kind = MessageKind.PairConfirmation;" line6="                    message.value = t.icon;" line7="                    message.toSerialNumber = t.id;" line8="                    message.send();" line9="                }" line10="                serial.writeLine(`pairing ${players.length} players`);" line11="                basic.pause(500);" line12="                break;" line13="            case GameState.Infecting:" line14="                if (patientZero.health == HealthState.Healthy) {" line15="                    message = new Message();" line16="                    message.kind = MessageKind.InitialInfect;" line17="                    message.toSerialNumber = patientZero.id;" line18="                    message.send();" line19="                    basic.pause(100);" line20="                } else {" line21="                    serial.writeLine(`patient ${patientZero.id} infected`);" line22="                    // show startup" line23="                    basic.showIcon(GameIcons.Dead);" line24="                    state = GameState.Running;" line25="                }" line26="                break;" line27="            case GameState.Running:" line28="                for (const u of players) {" line29="                    message = new Message();" line30="                    message.kind = MessageKind.HealthSet;" line31="                    message.value = u.health;" line32="                    message.toSerialNumber = u.id;" line33="                    message.send();" line34="                }" line35="                break;" line36="            case GameState.Over:" line37="                if (patientZero)" line38="                    patientZero.show();" line39="                break;" line40="        }" numlines="41"></mutation><next><block type="typescript_statement" id=".#Ps4.F;0Vs:g1PVnY1:" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="message = new Message()" numlines="1"></mutation><next><block type="typescript_statement" id="DGUG^/*I!3Kl(KV%onD6" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="message.kind = MessageKind.GameState;" numlines="1"></mutation><next><block type="typescript_statement" id="aH6}khzC#hdak#_|x?E0" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="message.value = state;" numlines="1"></mutation><next><block type="typescript_statement" id="YT,MNyu-kKH`b`{SU//`" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="message.send();" numlines="1"></mutation></block></next></block></next></block></next></block></next></block></statement><statement name="ELSE"><block type="typescript_statement" id="ihgOt1*@iZ(v^+^Zcad2" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (state) {" line1="            case GameState.Pairing:" line2="                // broadcast player id" line3="                if (playerIcon &lt; 0) {" line4="                    message = new Message();" line5="                    message.kind = MessageKind.PairRequest;" line6="                    message.fromSerialNumber = control.deviceSerialNumber();" line7="                    message.send();" line8="                } else if (infectedBy &gt; -1) {" line9="                    message = new Message();" line10="                    message.kind = MessageKind.HealthValue;" line11="                    message.fromSerialNumber = control.deviceSerialNumber();" line12="                    message.value = health;" line13="                    message.send();" line14="                }" line15="                break;" line16="            case GameState.Infecting:" line17="                message = new Message();" line18="                message.kind = MessageKind.HealthValue;" line19="                message.fromSerialNumber = control.deviceSerialNumber();" line20="                message.value = health;" line21="                message.send();" line22="                break;" line23="            case GameState.Running:" line24="                // update health status" line25="                if (health != HealthState.Healthy &amp;&amp; input.runningTime() - infectedTime &gt; DEATH)" line26="                    health = HealthState.Dead;" line27="                else if (health != HealthState.Healthy &amp;&amp; input.runningTime() - infectedTime &gt; INCUBATION)" line28="                    health = HealthState.Sick;" line29="                // transmit disease" line30="                if (health == HealthState.Incubating || health == HealthState.Sick) {" line31="                    message = new Message();" line32="                    message.kind = MessageKind.TransmitVirus;" line33="                    message.fromSerialNumber = control.deviceSerialNumber();" line34="                    message.value = playerIcon;" line35="                    message.send();" line36="                }" line37="                message = new Message();" line38="                message.kind = MessageKind.HealthValue;" line39="                message.fromSerialNumber = control.deviceSerialNumber();" line40="                message.value = health;" line41="                message.send();" line42="                break;" line43="        }" numlines="44"></mutation><next><block type="function_call" id="h$9_z@+/dmVD#,!mfz02"><mutation name="gameFace" functionid="}Nm(Oz;Y9sBH^+~cE_2`"/></block></next></block></statement></block></next></block></statement></block><block type="radio_on_buffer_drag" id="9(W_-C6QhcFeq`MJ]#:h" x="3109" y="20"><value name="HANDLER_DRAG_PARAM_receivedBuffer"><shadow type="argument_reporter_custom" id="{[Oauz-hd$`+k58Jx*ZD"><mutation typename="Buffer"/><field name="VALUE">receivedBuffer</field></shadow></value><statement name="HANDLER"><block type="typescript_statement" id="n6Dz@9`b:$8^B~hg.:}_" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="const incomingMessage = new Message(receivedBuffer);" numlines="1" declaredvars="incomingMessage"></mutation><next><block type="variables_set" id="obbg|QQkqe-Xx2,;Mx}K"><field name="VAR" id="Uf9U-r2(RdmJQ0zEG|r/">signal</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="radio_received_packet" id="ETh?9m:ZF+FND?JuQg6d"><value name="type"><shadow type="radio_packet_property" id="lO(Kx7.XtV30^wQcD2|i"><field name="note">RadioPacketProperty.SignalStrength</field></shadow></value></block></value><next><block type="controls_if" id="xa$;M7N4uB39=uGDQ#Kr"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="{=2c~CDk9SAK}$JZTf~}"><field name="VAR" id="Rs[1(6;Wg]z*qRA6`q=d">master</field></block></value><statement name="DO0"><block type="typescript_statement" id="UBn*lH/}Xp5~I/zPA1,Y" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (incomingMessage.kind) {" line1="            case MessageKind.PairRequest:" line2="                // register player" line3="                let n = players.length;" line4="                player(incomingMessage.fromSerialNumber);" line5="                // show player number if changed" line6="                if (n != players.length) {" line7="                    basic.showNumber(players.length);" line8="                }" line9="                break;" line10="            case MessageKind.HealthValue:" line11="                let s = player(incomingMessage.fromSerialNumber);" line12="                s.health = incomingMessage.value;" line13="                // check if all infected" line14="                if (allDead())" line15="                    gameOver();" line16="                break;" line17="        }" numlines="18"></mutation></block></statement><statement name="ELSE"><block type="typescript_statement" id="yy`,u*84NDBUQ]k0ZlVh" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (incomingMessage.kind) {" line1="            case MessageKind.GameState:" line2="                // update game state" line3="                state = incomingMessage.value as GameState;" line4="                break;" line5="            case MessageKind.InitialInfect:" line6="                if (infectedBy &lt; 0 &amp;&amp;" line7="                    incomingMessage.toSerialNumber == control.deviceSerialNumber()) {" line8="                    // infected by master" line9="                    infectedBy = 0; // infected my master" line10="                    infectedTime = input.runningTime();" line11="                    health = HealthState.Incubating;" line12="                    serial.writeLine(`infected ${control.deviceSerialNumber()}`);" line13="                }" line14="                break;" line15="            case MessageKind.HealthSet:" line16="                if (incomingMessage.toSerialNumber == control.deviceSerialNumber()) {" line17="                    const newHealth = incomingMessage.value;" line18="                    if (health &lt; newHealth) {" line19="                        health = newHealth;" line20="                    }" line21="                }" line22="                break;" line23="            case MessageKind.PairConfirmation:" line24="                if (!paired &amp;&amp; state == GameState.Pairing &amp;&amp;" line25="                    incomingMessage.toSerialNumber == control.deviceSerialNumber()) {" line26="                    // paired!" line27="                    serial.writeLine(`player paired ==&gt; ${control.deviceSerialNumber()}`)" line28="                    playerIcon = incomingMessage.value;" line29="                    paired = true;" line30="                }" line31="                break;" line32="            case MessageKind.TransmitVirus:" line33="                if (state == GameState.Running) {" line34="                    if (health == HealthState.Healthy) {" line35="                        serial.writeLine(`signal: ${signal}`);" line36="                        if (signal &gt; RSSI &amp;&amp;" line37="                            randint(0, 100) &gt; TRANSMISSIONPROB) {" line38="                            infectedBy = incomingMessage.value;" line39="                            infectedTime = input.runningTime();" line40="                            health = HealthState.Incubating;" line41="                        }" line42="                    }" line43="                }" line44="                break;" line45="            case MessageKind.HealthValue:" line46="                if (health != HealthState.Dead &amp;&amp; signal &gt; RSSI) {" line47="                    game.addScore(1);" line48="                }" line49="                break;" line50="        }" numlines="51"></mutation></block></statement></block></next></block></next></block></statement></block><block type="function_definition" id="~3(|H=.H-lKyWn)m*$}r" x="4089" y="20"><mutation name="player" functionid="mioyxh^heLN4?2,AZp6b"><arg name="id" id="dnea41i7bptcuanetlqls" type="number"/></mutation><field name="function_name">player</field><comment>get a player instance (creates one as needed)</comment><statement name="STACK"><block type="pxt_controls_for_of" id="(tK.L|B*jl@lzq%^C(Lb"><value name="VAR"><shadow type="variables_get_reporter" id="Z8C4!0B4]!_@O-{JG/Zy"><field name="VAR" id="?SE7EEPQi$~TO)$Kj+{8">p</field></shadow></value><value name="LIST"><block type="variables_get" id="_R)mw!vv#-FF;#Bi%7XD"><field name="VAR" id="wXvw2`rH4v3JGs?-sTk@">players</field></block></value><statement name="DO"><block type="controls_if" id="E.Vsc[+.Qx5WsrIQFmZt"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="l0##%DwT0ReI-5_QWgF^"><field name="OP">EQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="+Nu80P_2Mu5y^Sp[d5A4" editable="false"><field name="EXPRESSION">p.id</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="argument_reporter_number" id="8Upa,~-T+QvK0Bk$mP2X"><field name="VALUE">id</field></block></value></block></value><statement name="DO0"><block type="function_return" id="J{X=Jj9RVM-(Y}gvtKEy"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="uC!)Z9`qwg!rRK+xv|}P"><field name="VAR" id="?SE7EEPQi$~TO)$Kj+{8">p</field></block></value></block></statement></block></statement><next><block type="typescript_statement" id="$0Im*RF~1usi_A+T[MYR" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let q = new Player();" numlines="1" declaredvars="q"></mutation><next><block type="typescript_statement" id="s:@0[)qb^Q9FSOb:(jp~" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="q.id = id;" numlines="1"></mutation><next><block type="typescript_statement" id="p;k$N1V#Se~cK6N;/pH!" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="q.icon = (players.length + 1) % playerIcons.length;" numlines="1"></mutation><next><block type="typescript_statement" id="!8R$FI)oTz~~f;KP!368" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="q.health = HealthState.Healthy;" numlines="1"></mutation><next><block type="array_push" id="]sxKw2.j;3~eHbu;t.`T"><value name="list"><block type="variables_get" id="E.!Z%-^`0TzF}Z)q=8E$"><field name="VAR" id="wXvw2`rH4v3JGs?-sTk@">players</field></block></value><value name="value"><block type="variables_get" id="Je!$=Rw-+v37ad[Wq4-a"><field name="VAR" id="am:[tvD[VIL4h5pdKMv=">q</field></block></value><next><block type="serial_writeline" id=")gbxE[HfwJ2YhrI*tA2-"><value name="text"><block type="typescript_expression" id="c/Kse}p2BK^tT;ah6v6Z" editable="false"><field name="EXPRESSION">`player ==&gt; ${q.id}`</field></block></value><next><block type="function_return" id="iw)XP;A:GSM11GKS%?cb"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="5gy:YnispuC-!x(K-lJS"><field name="VAR" id="am:[tvD[VIL4h5pdKMv=">q</field></block></value></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="function_definition" id="G76,kU3|=1(vE^K$}98o" x="4667" y="20"><mutation name="allDead" functionid=";1B,:!eLHs}3n2_A--I:"/><field name="function_name">allDead</field><statement name="STACK"><block type="pxt_controls_for_of" id="+xi_3v1-*Fo;4A~+iy5?"><value name="VAR"><shadow type="variables_get_reporter" id="sKR,De.(%^/,LA!k[^@2"><field name="VAR" id="qZ41MJ$5vtjxcO8)#;_i">r</field></shadow></value><value name="LIST"><block type="variables_get" id="*+#b;B4~]B91)6}D!{)%"><field name="VAR" id="wXvw2`rH4v3JGs?-sTk@">players</field></block></value><statement name="DO"><block type="controls_if" id=")LXSo7[jvPrhYG;q6nVE"><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="eS#l0Guj-LOtz2P:3.%O"><field name="OP">NEQ</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="}.R!;DTcv={!9.^9A{SO" editable="false"><field name="EXPRESSION">r.health</field></block></value><value name="B"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="!98(tr=P_[feP{=ckS=*" editable="false"><field name="EXPRESSION">HealthState.Dead</field></block></value></block></value><statement name="DO0"><block type="function_return" id="BPR;a-7.QiBTgyi=sz`z"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="n5x7!sCq#mW#cG@a+}t@"><field name="BOOL">FALSE</field></block></value></block></statement></block></statement><next><block type="function_return" id="]RxXsQkkV7y4Zdvk.VvF"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="logic_boolean" id="U[/ih#VB[JCK|cvYG^/e"><field name="BOOL">TRUE</field></block></value></block></next></block></statement></block><block type="function_definition" id="3~dt~^rv0p[}:j6`8$2x" x="5297" y="20"><mutation name="gameOver" functionid="%W7iwgd5y3ncGw]Sg+S;"/><field name="function_name">gameOver</field><statement name="STACK"><block type="typescript_statement" id="gb.+/7{Irs$3gf_^!Yl]" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="state = GameState.Over;" numlines="1"></mutation><next><block type="controls_if" id="RrZ4w*tj%tGdP.S/j[M="><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="variables_get" id="5He-$ER;R;=k:Yo.K7_w"><field name="VAR" id="w}cJ[/Q|S~0sl)(KMVs=">patientZero</field></block></value><statement name="DO0"><block type="typescript_statement" id=",E(V1751,w:g}%b:bndC" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="patientZero.show();" numlines="1"></mutation></block></statement></block></next></block></statement></block><block type="function_definition" id="ay:kFX;dNOg#q(w1Q(UN" x="5661" y="20"><mutation name="gameFace" functionid="}Nm(Oz;Y9sBH^+~cE_2`"/><field name="function_name">gameFace</field><statement name="STACK"><block type="typescript_statement" id="C%tx-4VzglihNhusG(1e" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="switch (state) {" line1="        case GameState.Stopped:" line2="            basic.showIcon(GameIcons.Pairing);" line3="            break;" line4="        case GameState.Pairing:" line5="            if (playerIcon &gt; -1)" line6="                basic.showString(playerIcons[playerIcon]);" line7="            else" line8="                basic.showIcon(paired ? GameIcons.Paired : GameIcons.Pairing, 1);" line9="            break;" line10="        case GameState.Infecting:" line11="        case GameState.Running:" line12="            switch (health) {" line13="                case HealthState.Dead:" line14="                    basic.showIcon(GameIcons.Dead, 1);" line15="                    break;" line16="                case HealthState.Sick:" line17="                    basic.showIcon(GameIcons.Sick, 1);" line18="                    break;" line19="                default:" line20="                    basic.showIcon(GameIcons.Healthy, 1);" line21="                    break;" line22="            }" line23="            break;" line24="        case GameState.Over:" line25="            // show id" line26="            basic.showString(playerIcons[playerIcon]);" line27="            basic.pause(2000);" line28="            // show health" line29="            switch (health) {" line30="                case HealthState.Dead:" line31="                    basic.showIcon(GameIcons.Dead, 2000);" line32="                    break;" line33="                case HealthState.Sick:" line34="                    basic.showIcon(GameIcons.Sick, 2000);" line35="                    break;" line36="                case HealthState.Incubating:" line37="                    basic.showIcon(GameIcons.Incubating, 2000);" line38="                    break;" line39="                default:" line40="                    basic.showIcon(GameIcons.Healthy, 2000);" line41="                    break;" line42="            }" line43="            // show how infected" line44="            if (infectedBy &gt; -1) {" line45="                basic.showString(&quot; INFECTED BY&quot;);" line46="                basic.showString(playerIcons[infectedBy]);" line47="                basic.pause(2000);" line48="            } else {" line49="                basic.showString(&quot; PATIENT ZERO&quot;);" line50="                basic.pause(2000);" line51="            }" line52="            // show score" line53="            game.showScore();" line54="            basic.pause(1000);" line55="            break;" line56="    }" numlines="57"></mutation></block></statement></block></xml>